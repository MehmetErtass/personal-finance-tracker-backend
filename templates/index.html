<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personal Finance Tracker</title>

  <!-- Internal CSS for styling the UI elements -->
  <style>
    /* Body and typography styling */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 30px;
      background: #f9f9f9;
      color: #2c3e50;
      line-height: 1.6;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Headings styling */
    h1, h2 {
      text-align: center;
      margin-bottom: 1rem;
    }

    /* Transaction form container styling */
    form {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      max-width: 480px;
      margin: 0 auto 2rem;
    }

    /* Label and input styling */
    label {
      display: block;
      margin-top: 15px;
      font-weight: 700;
    }
    input, select, button {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #3498db;
      outline: none;
    }

    /* Submit button styling */
    button {
      background-color: #3498db;
      color: white;
      border: none;
      margin-top: 20px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }

    /* Transaction table styling */
    table {
      width: 100%;
      border-collapse: collapse;
      box-shadow: 0 3px 12px rgba(0,0,0,0.1);
      background: white;
      margin-bottom: 2rem;
    }
    th, td {
      padding: 14px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #2c3e50;
      color: white;
      font-weight: 700;
    }
    tr:hover {
      background-color: #f1f1f1;
    }

    /* Buttons for edit, delete, save, cancel */
    .btn-edit, .btn-delete, .btn-save, .btn-cancel {
      cursor: pointer;
      padding: 6px 14px;
      margin-right: 6px;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .btn-edit { background-color: #27ae60; }
    .btn-edit:hover { background-color: #219150; }
    .btn-delete { background-color: #e74c3c; }
    .btn-delete:hover { background-color: #c0392b; }
    .btn-save { background-color: #2980b9; }
    .btn-save:hover { background-color: #1f5e8b; }
    .btn-cancel { background-color: #7f8c8d; }
    .btn-cancel:hover { background-color: #606b6e; }

    /* Responsive design for small screens */
    @media (max-width: 600px) {
      form, table {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Personal Finance Tracker</h1>

  <!-- Form to add new transactions -->
  <form id="transaction-form" aria-label="Add new transaction form" novalidate>
    <label for="amount">Amount</label>
    <input id="amount" name="amount" type="number" step="0.01" min="0.01" required aria-required="true" aria-describedby="amountHelp" />
    <small id="amountHelp" style="color: gray;">Enter a positive number</small>

    <label for="transaction_type">Transaction Type</label>
    <select id="transaction_type" name="transaction_type" required aria-required="true" aria-describedby="typeHelp">
      <option value="">Select type</option>
      <option value="income">Income</option>
      <option value="expense">Expense</option>
    </select>
    <small id="typeHelp" style="color: gray;">Choose Income or Expense</small>

    <label for="description">Description</label>
    <input id="description" name="description" type="text" maxlength="1000" required aria-required="true" aria-describedby="descHelp" />
    <small id="descHelp" style="color: gray;">Describe the transaction (max 1000 characters)</small>

    <button type="submit">Add Transaction</button>
  </form>

  <!-- Table to display transaction list -->
  <h2>Transactions</h2>
  <table id="transactions-table" aria-live="polite" aria-label="List of transactions">
    <thead>
      <tr>
        <th>ID</th>
        <th>Amount</th>
        <th>Type</th>
        <th>Category</th>
        <th>Date</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- JavaScript for client-side interaction -->
  <script>
    "use strict";

    const apiUrl = "/api/transactions";
    const tbody = document.querySelector("#transactions-table tbody");
    const form = document.getElementById("transaction-form");

    // Helper: Escape special characters for safe HTML rendering (XSS protection)
    function escapeHtml(text) {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      };
      return text.replace(/[&<>"']/g, (m) => map[m]);
    }

    // Fetch transactions from backend and render in table
    async function fetchTransactions() {
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error("Network response was not ok");
        const transactions = await response.json();

        tbody.innerHTML = ""; // Clear current table

        transactions.forEach(({ id, amount, transaction_type, category, transaction_date, description }) => {
          const tr = document.createElement("tr");
          tr.dataset.id = id;

          tr.innerHTML = `
            <td>${id}</td>
            <td class="amount">${amount.toFixed(2)}</td>
            <td class="type">${transaction_type}</td>
            <td class="category">${category || "-"}</td>
            <td>${transaction_date}</td>
            <td class="description">${escapeHtml(description)}</td>
            <td>
              <button class="btn-edit" aria-label="Edit transaction ${id}">Edit</button>
              <button class="btn-delete" aria-label="Delete transaction ${id}">Delete</button>
            </td>
          `;

          tbody.appendChild(tr);
        });
      } catch (error) {
        alert("Failed to load transactions.");
        console.error(error);
      }
    }

    // Handle new transaction form submission
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const amount = parseFloat(form.amount.value);
      const transaction_type = form.transaction_type.value;
      const description = form.description.value.trim();

      if (isNaN(amount) || amount <= 0) {
        alert("Please enter a valid positive amount.");
        return;
      }
      if (!transaction_type) {
        alert("Please select a transaction type.");
        return;
      }
      if (!description) {
        alert("Description cannot be empty.");
        return;
      }

      const payload = { amount, transaction_type, description };

      try {
        const response = await fetch(apiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || "Failed to add transaction.");
        }

        alert("Transaction added successfully!");
        form.reset();
        fetchTransactions();
      } catch (error) {
        alert(error.message);
      }
    });

    // Handle edit/delete actions using event delegation
    tbody.addEventListener("click", async (e) => {
      const tr = e.target.closest("tr");
      if (!tr) return;
      const id = tr.dataset.id;

      if (e.target.classList.contains("btn-delete")) {
        if (!confirm("Are you sure you want to delete this transaction?")) return;

        try {
          const response = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
          if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || "Failed to delete transaction.");
          }
          alert("Transaction deleted.");
          fetchTransactions();
        } catch (error) {
          alert(error.message);
        }
      }

      if (e.target.classList.contains("btn-edit")) {
        enterEditMode(tr);
      }
    });

    // Enable row editing mode
    function enterEditMode(tr) {
      const amountTd = tr.querySelector(".amount");
      const typeTd = tr.querySelector(".type");
      const categoryTd = tr.querySelector(".category");
      const descriptionTd = tr.querySelector(".description");
      const actionTd = tr.querySelector("td:last-child");

      // Save original values for cancel functionality
      tr.dataset.originalAmount = amountTd.textContent;
      tr.dataset.originalType = typeTd.textContent;
      tr.dataset.originalCategory = categoryTd.textContent;
      tr.dataset.originalDescription = descriptionTd.textContent;

      // Replace cells with input fields
      amountTd.innerHTML = `<input type="number" step="0.01" min="0.01" value="${amountTd.textContent}" class="edit-amount" aria-label="Edit amount" />`;
      typeTd.innerHTML = `
        <select class="edit-type" aria-label="Edit transaction type">
          <option value="income" ${typeTd.textContent === "income" ? "selected" : ""}>Income</option>
          <option value="expense" ${typeTd.textContent === "expense" ? "selected" : ""}>Expense</option>
        </select>
      `;
      categoryTd.innerHTML = `<input type="text" value="${categoryTd.textContent === "-" ? "" : categoryTd.textContent}" class="edit-category" aria-label="Edit category" />`;
      descriptionTd.innerHTML = `<input type="text" value="${descriptionTd.textContent}" class="edit-description" aria-label="Edit description" />`;

      actionTd.innerHTML = `
        <button class="btn-save" aria-label="Save changes">Save</button>
        <button class="btn-cancel" aria-label="Cancel editing">Cancel</button>
      `;

      actionTd.querySelector(".btn-save").addEventListener("click", () => saveEdit(tr));
      actionTd.querySelector(".btn-cancel").addEventListener("click", () => cancelEdit(tr));
    }

    // Save edited transaction via API
    async function saveEdit(tr) {
      const id = tr.dataset.id;
      const amount = parseFloat(tr.querySelector(".edit-amount").value);
      const transaction_type = tr.querySelector(".edit-type").value;
      const description = tr.querySelector(".edit-description").value.trim();
      const category = tr.querySelector(".edit-category").value.trim();

      if (isNaN(amount) || amount <= 0) {
        alert("Amount must be a positive number.");
        return;
      }
      if (!transaction_type) {
        alert("Please select a transaction type.");
        return;
      }
      if (!description) {
        alert("Description cannot be empty.");
        return;
      }

      const payload = { amount, transaction_type, description };
      if (category) payload.category = category;

      try {
        const response = await fetch(`${apiUrl}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || "Failed to update transaction.");
        }
        alert("Transaction updated successfully.");
        fetchTransactions();
      } catch (error) {
        alert(error.message);
      }
    }

    // Cancel edit and revert to original row content
    function cancelEdit(tr) {
      tr.querySelector(".amount").textContent = tr.dataset.originalAmount;
      tr.querySelector(".type").textContent = tr.dataset.originalType;
      tr.querySelector(".category").textContent = tr.dataset.originalCategory;
      tr.querySelector(".description").textContent = tr.dataset.originalDescription;
      tr.querySelector("td:last-child").innerHTML = `
        <button class="btn-edit">Edit</button>
        <button class="btn-delete">Delete</button>
      `;
    }

    // Initial load of transaction data
    fetchTransactions();
  </script>
</body>
</html>
